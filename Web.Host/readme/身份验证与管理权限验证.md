## 1 身份验证
### 1.1 访问令牌jwt
```
eyJhbGciOiJSUzI1NiIsImtpZCI6IkM1MTVCRTM4RDg0RDI4MkZCMDc1NENDRUY5NUNDQkU1OUE5NUU3RjgiLCJ0eXAiOiJKV1QiLCJ4NXQiOiJ4UlctT05oTktDLXdkVXpPLVZ6TDVacVY1X2cifQ.eyJuYmYiOjE1NjM3NjE1OTEsImV4cCI6MTU2Mzg0Nzk5MSwiaXNzIjoiaHR0cDovL2FjY291bnR2NC50YWljaHVhbi5uZXQiLCJhdWQiOlsiaHR0cDovL2FjY291bnR2NC50YWljaHVhbi5uZXQvcmVzb3VyY2VzIiwiaWRlbnRpdHkiLCJ1aG9tZSJdLCJjbGllbnRfaWQiOiJ1aG9tZS53ZWIiLCJzdWIiOiJVMTYwNTMxMDAwMDAxIiwiYXV0aF90aW1lIjoxNTYzNzYxNTkxLCJpZHAiOiJsb2NhbCIsInJvbGUiOiJVSE9NRV9NQU5BR0UiLCJuYW1lIjoiYWRtaW4iLCJzY29wZSI6WyJpZGVudGl0eSIsInVob21lLnBhcmsiLCJ1aG9tZS5ya2UiLCJ1aG9tZS5vMm8iXSwiYW1yIjpbInB3ZCJdfQ.ZAGAi_tO7ylKFF41LPjtCgh9iA8VRyCoJt0lo2zbSYIwZchF5N_hH-4SP1QoJZMoG-DRkkArm-KPe2UkiU7Qo9Sp56la5sEC0CkWVsZtlXUb6NXfRoM2HjYCxOlYMWH--l1uZUTJH7YdkJAXUxr3G0q5l3CeeSjnIuN3qnihEVX3QMby499_OqEeqMcLebdFoIk4Gm1AwGISu7rFxP-P2r-HOjg6MgLFbFO8ORRhp0lvYLQfdF68u8Jq3sNkSit6XgBCKQouLUfGcY5uB6X6xBrh9OwsQ5I1Tz0l2P4u03PRUd63r_fehCSeBMsextTSWWUD5qnrbNaIlH27c_KArQ
```

### 1.2 jwt的header
```
{
  "alg": "RS256",
  "kid": "C515BE38D84D282FB0754CCEF95CCBE59A95E7F8",
  "typ": "JWT",
  "x5t": "xRW-ONhNKC-wdUzO-VzL5ZqV5_g"
}
```

### 1.3 jwt的payloay
```
{
  "nbf": 1563761591,
  "exp": 1563847991,
  "iss": "http://accountv4.taichuan.net",
  "aud": [
    "http://accountv4.taichuan.net/resources",
    "identity",
    "uhome"
  ],
  "client_id": "uhome.web",
  "sub": "U160531000001",
  "auth_time": 1563761591,
  "idp": "local",
  "role": "UHOME_MANAGE",
  "name": "admin",
  "scope": [
    "identity",
    "uhome.park",
    "uhome.rke",
    "uhome.o2o"
  ],
  "amr": [
    "pwd"
  ]
}
```

### 1.4 jwt发放与验证流程
1. 数据中心提供注册和登录接口，登录获取RS256算法的jwt
2. 在网关配置RS256 jwt验证公钥，网关统一为所有需要身份验证的服务提供jwt合法性、时效性验证
3. jwt的payload包含用户对应的多个role(角色）和多个scope(资源范围)，微服务需要解析jwt并验证role和scope是否与本服务吻合


## 2 管理权限

### 2.1 概念解释
一个系统的用户体系会分为多个角色，
这些角色里包含管理者角色，比如UHOME_MANAGE。对于UHOME_MANAGE下的不同管理人员，
我们希望他们可以访问到所有菜单功能的全部或部分，在子系统里维护管理员与管理员的关系，
管理员与菜单功能的关系就叫做管理权限



### 2.2 管理员之间关系
```
        A
    B        C
  D    E   F   G
```
管理员的关系可以维护一个金字塔，在数据结构上为树形结构，
在数据存储时每条数据要记录自己的parentId

### 2.3 管理员与菜单关系
每个管理员，可以给自己子级分配菜单访问权限，
可以选择的菜单为自己能访问到这些菜单，也就是说，B管理员的菜单是<=A管理的菜单，
以此类推。

### 2.4 菜单描述
菜单本质上是描述了管理员能访问的api和api的辅助说明。在前端，菜单还体现分组的概念；在系统后台，
需要维护菜单的分组的排序，以及组内菜单节点的排序。


```
[
    {
        "group": "基础数据",
        "items": [
            {
                "groupName": "基础数据",
                "name": "社区结构",
                "class": null,               
                "relativePath": "api/rke-admin/roomstructs"                
            }
        ]
    },
    {
        "group": "日志管理",
        "items": [
            {
                "groupName": "日志管理",
                "name": "报警日志",
                "class": null,                
                "relativePath": "api/rke-device-log/admin/alarmlogs"
            },
            {
                "groupName": "日志管理",
                "name": "开锁日志",
                "class": "open",               
                "relativePath": "api/rke-device-log/admin/unlocklogs"               
            }
        ]
    }
]
```

### 2.5 菜单权限验证
通过解析jwt里面的sub，同时获取当前访问的api，判断sub与api的关系是否在db中存在。
考虑到接口访问频繁度，最好把sub和sub能访问的所有菜单缓存到内存或redis中，然后在内存中比较与验证。